FROM cgr.dev/chainguard/dotnet-sdk:latest AS build
USER root
WORKDIR /src
COPY dotnet-test.csproj ./
RUN dotnet restore
COPY . .
RUN dotnet publish -c Release -o /app/publish /p:UseAppHost=false
COPY certificate.crt /usr/local/share/ca-certificates/
RUN cat /usr/local/share/ca-certificates/certificate.crt >> /etc/ssl/certs/ca-certificates.crt
RUN chown -R nonroot:nonroot /app/publish
USER nonroot

# --- runtime stage ---
FROM cgr.dev/chainguard/dotnet-runtime:latest AS runtime
WORKDIR /app
COPY --from=build /app/publish ./
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

# Env options:
# - WELL_KNOWN_URL                (full URL) OR
# - KEYCLOAK_BASE_URL + KEYCLOAK_REALM
# - ALLOW_INSECURE_HTTP=true      (only if you must talk to http://)
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1

ENTRYPOINT ["dotnet", "dotnet-test.dll"]
