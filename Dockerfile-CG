
FROM cgr.dev/chainguard/dotnet-sdk:latest AS build
WORKDIR /src
COPY --chown=nonroot:nonroot dotnet-test.csproj ./
RUN dotnet restore
COPY --chown=nonroot:nonroot . .
RUN dotnet publish -c Release -o /app/publish /p:UseAppHost=false

# --- runtime stage ---
FROM cgr.dev/chainguard/dotnet-runtime:latest AS runtime
WORKDIR /app
COPY --from=build /app/publish ./

# Env options:
# - WELL_KNOWN_URL                (full URL) OR
# - KEYCLOAK_BASE_URL + KEYCLOAK_REALM
# - ALLOW_INSECURE_HTTP=true      (only if you must talk to http://)
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1

ENTRYPOINT ["dotnet", "dotnet-test.dll"]